AWSTemplateFormatVersion: '2010-09-09'
Description: DynamoDB tables for Codebreaker
Parameters:
  JudgeName:
    Type: String
Resources:
  AnnouncementsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-announcements
      AttributeDefinitions:
      - AttributeName: announcementId
        AttributeType: S
      KeySchema:
      - AttributeName: announcementId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  ClarificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-clarifications
      AttributeDefinitions:
      - AttributeName: askedBy
        AttributeType: S
      - AttributeName: clarificationTime
        AttributeType: S
      KeySchema:
      - AttributeName: askedBy
        KeyType: HASH
      - AttributeName: clarificationTime
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
  ContestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-contests
      AttributeDefinitions:
      - AttributeName: contestId
        AttributeType: S
      KeySchema:
      - AttributeName: contestId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  GlobalCountersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-global-counters
      AttributeDefinitions:
      - AttributeName: counterId
        AttributeType: S
      KeySchema:
      - AttributeName: counterId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  ProblemsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-problems
      AttributeDefinitions:
      - AttributeName: problemName
        AttributeType: S
      KeySchema:
      - AttributeName: problemName
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  SubmissionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-submissions
      AttributeDefinitions:
      - AttributeName: subId
        AttributeType: N
      - AttributeName: problemName
        AttributeType: S
      - AttributeName: username
        AttributeType: S
      KeySchema:
      - AttributeName: subId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
      - IndexName: problemIndex
        KeySchema:
        - AttributeName: problemName
          KeyType: HASH
        - AttributeName: subId
          KeyType: RANGE
        Projection:
          ProjectionType: INCLUDE
          NonKeyAttributes:
          - submissionTime
          - maxTime
          - maxMemory
          - username
          - totalScore
          - language
          - compileErrorMessage
      - IndexName: usernameIndex
        KeySchema:
        - AttributeName: username
          KeyType: HASH
        - AttributeName: subId
          KeyType: RANGE
        Projection:
          ProjectionType: INCLUDE
          NonKeyAttributes:
          - submissionTime
          - maxTime
          - maxMemory
          - problemName
          - totalScore
          - language
          - compileErrorMessage
          - score
          - subtaskScores
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-users
      AttributeDefinitions:
      - AttributeName: username
        AttributeType: S
      - AttributeName: contestId
        AttributeType: S
      KeySchema:
      - AttributeName: username
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
      - IndexName: contestIndex
        KeySchema:
        - AttributeName: contestId
          KeyType: HASH
        - AttributeName: username
          KeyType: RANGE
        Projection:
          ProjectionType: KEYS_ONLY
  WebSocketTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${JudgeName}-websocket
      AttributeDefinitions:
      - AttributeName: connectionId
        AttributeType: S
      - AttributeName: accountRole
        AttributeType: S
      - AttributeName: username
        AttributeType: S
      KeySchema:
      - AttributeName: connectionId
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
      - IndexName: accountRoleUsernameIndex
        KeySchema:
        - AttributeName: accountRole
          KeyType: HASH
        - AttributeName: username
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiryTime
        Enabled: true
